- name: Update Prometheus scrape config for Podman metrics
  hosts: monitoring_nodes
  become: true
  tasks:
    - name: Ensure Prometheus scrape config includes Podman endpoints
      copy:
        dest: /etc/prometheus/prometheus.yml
        content: |
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'node_exporters'
              static_configs:
                - targets:
{{ groups['monitoring_nodes'] | default([]) | map('regex_replace','^(.*)$','\1:9100') | join("\n                    - '") | default('') }}
{{ groups['storage_nodes'] | default([]) | map('regex_replace','^(.*)$','\1:9100') | join("\n                    - '") | default('') }}
{{ groups['compute_nodes'] | default([]) | map('regex_replace','^(.*)$','\1:9100') | join("\n                    - '") | default('') }}
            - job_name: 'podman_metrics'
              static_configs:
                - targets:
{{ groups['monitoring_nodes'] | default([]) | map('regex_replace','^(.*)$','\1:9882') | join("\n                    - '") | default('') }}
{{ groups['storage_nodes'] | default([]) | map('regex_replace','^(.*)$','\1:9882') | join("\n                    - '") | default('') }}
{{ groups['compute_nodes'] | default([]) | map('regex_replace','^(.*)$','\1:9882') | join("\n                    - '") | default('') }}
            # Add more scrape configs as needed
