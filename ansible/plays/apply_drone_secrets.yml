- hosts: compute_nodes
  connection: local
  gather_facts: false
  vars_files:
    - ../group_vars/secrets.yml
  tasks:
    - name: Check Kubernetes API connectivity (quick)
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: kube-system
      register: k8s_api_check
      failed_when: false
      changed_when: false

    - name: Fail early with helpful message if Kubernetes API unreachable
      ansible.builtin.fail:
        msg: |
          Kubernetes API appears unreachable or timed out. This play creates cluster resources (namespace and secrets) and requires a functioning API server.
          Check cluster connectivity and kubeconfig before retrying.
      when: k8s_api_check is not defined or (k8s_api_check is defined and k8s_api_check.failed)

    - name: Ensure drone namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: drone
      register: drone_namespace_result
      retries: 5
      delay: 3
      until: drone_namespace_result is not failed or 
             ("Too Many Requests" not in (drone_namespace_result.msg | default("")) and
              "too many requests" not in (drone_namespace_result.msg | default("")) and
              "rate limit" not in (drone_namespace_result.msg | default("")))
      failed_when: false

    - name: Check drone namespace creation result
      ansible.builtin.fail:
        msg: |
          Failed to create drone namespace after retries. Last error: {{ drone_namespace_result.msg | default('Unknown error') }}
          This may indicate a persistent API server issue or network connectivity problems.
          Try running the playbook again after a few minutes.
      when: drone_namespace_result is defined and drone_namespace_result.failed | default(false)

    - name: Add delay to prevent API rate limiting
      ansible.builtin.pause:
        seconds: 2

    - name: Create drone secrets from group_vars
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: drone-secrets
            namespace: drone
          type: Opaque
          stringData:
            rpc-secret: "{{ drone_rpc_secret | default('changeme') }}"
            github-client-id: "{{ drone_github_client_id | default('') }}"
            github-client-secret: "{{ drone_github_client_secret | default('') }}"
            server-host: "{{ drone_server_host | default('') }}"
      register: drone_secrets_result
      retries: 5
      delay: 2
      until: drone_secrets_result is not failed or 
             ("Too Many Requests" not in (drone_secrets_result.msg | default("")) and
              "too many requests" not in (drone_secrets_result.msg | default("")) and
              "rate limit" not in (drone_secrets_result.msg | default("")))
      failed_when: false

    - name: Check drone secrets creation result
      ansible.builtin.fail:
        msg: |
          Failed to create drone secrets after retries. Last error: {{ drone_secrets_result.msg | default('Unknown error') }}
          This may indicate a persistent API server issue or network connectivity problems.
          Try running the playbook again after a few minutes.
      when: drone_secrets_result is defined and drone_secrets_result.failed | default(false)