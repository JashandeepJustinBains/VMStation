{"schemaVersion":27,"title":"CoreDNS Performance & Health","uid":"coredns-performance","tags":["coredns","dns","kubernetes","vmstation","enterprise"],"timezone":"browser","editable":true,"refresh":"30s","time":{"from":"now-1h","to":"now"},"panels":[{"id":1,"title":"CoreDNS Status","type":"stat","datasource":"Prometheus","gridPos":{"h":4,"w":4,"x":0,"y":0},"targets":[{"expr":"sum(up{job=\"kubernetes-service-endpoints\", service=~\".*coredns.*|.*kube-dns.*\"})","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short","mappings":[{"options":{"0":{"text":"Down","color":"red"}},"type":"value"}],"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"yellow","value":1},{"color":"green","value":2}]}}},"options":{"colorMode":"background","graphMode":"none","orientation":"auto","textMode":"value_and_name"}},{"id":2,"title":"Total Queries (5m)","type":"stat","datasource":"Prometheus","gridPos":{"h":4,"w":5,"x":4,"y":0},"targets":[{"expr":"sum(increase(coredns_dns_requests_total[5m]))","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short","color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}}},"options":{"colorMode":"value","graphMode":"area","orientation":"auto"}},{"id":3,"title":"Cache Hit Rate","type":"gauge","datasource":"Prometheus","gridPos":{"h":4,"w":5,"x":9,"y":0},"targets":[{"expr":"sum(rate(coredns_cache_hits_total[5m])) / (sum(rate(coredns_cache_hits_total[5m])) + sum(rate(coredns_cache_misses_total[5m]))) * 100","refId":"A"}],"fieldConfig":{"defaults":{"unit":"percent","min":0,"max":100,"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"yellow","value":50},{"color":"green","value":80}]}}},"options":{"showThresholdLabels":false,"showThresholdMarkers":true}},{"id":4,"title":"Query Errors (5m)","type":"stat","datasource":"Prometheus","gridPos":{"h":4,"w":5,"x":14,"y":0},"targets":[{"expr":"sum(increase(coredns_dns_responses_total{rcode!=\"NOERROR\"}[5m]))","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short","color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":10},{"color":"red","value":100}]}}},"options":{"colorMode":"value","graphMode":"area","orientation":"auto"}},{"id":5,"title":"Pod Restart Count","type":"stat","datasource":"Prometheus","gridPos":{"h":4,"w":5,"x":19,"y":0},"targets":[{"expr":"sum(increase(kube_pod_container_status_restarts_total{pod=~\"coredns.*\"}[1h]))","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short","color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":3}]}}},"options":{"colorMode":"value","graphMode":"area","orientation":"auto"}},{"id":6,"title":"DNS Query Rate by Type","type":"timeseries","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":0,"y":4},"targets":[{"expr":"sum by (type) (rate(coredns_dns_requests_total[5m]))","legendFormat":"{{type}}","refId":"A"}],"fieldConfig":{"defaults":{"unit":"qps","color":{"mode":"palette-classic"},"custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":2,"showPoints":"never","stacking":{"mode":"normal"}}}},"options":{"legend":{"displayMode":"table","placement":"right","calcs":["mean","max","last"]}}},{"id":7,"title":"DNS Response Time (Percentiles)","type":"timeseries","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":12,"y":4},"targets":[{"expr":"histogram_quantile(0.99, sum(rate(coredns_dns_request_duration_seconds_bucket[5m])) by (le))","legendFormat":"99th Percentile","refId":"A"},{"expr":"histogram_quantile(0.95, sum(rate(coredns_dns_request_duration_seconds_bucket[5m])) by (le))","legendFormat":"95th Percentile","refId":"B"},{"expr":"histogram_quantile(0.50, sum(rate(coredns_dns_request_duration_seconds_bucket[5m])) by (le))","legendFormat":"Median","refId":"C"}],"fieldConfig":{"defaults":{"unit":"s","color":{"mode":"palette-classic"},"custom":{"drawStyle":"line","fillOpacity":5,"lineWidth":2,"showPoints":"never"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":0.05},{"color":"red","value":0.1}]}}},"options":{"legend":{"displayMode":"list","placement":"bottom"}}},{"id":8,"title":"DNS Response Codes","type":"timeseries","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":0,"y":12},"targets":[{"expr":"sum by (rcode) (rate(coredns_dns_responses_total[5m]))","legendFormat":"{{rcode}}","refId":"A"}],"fieldConfig":{"defaults":{"unit":"qps","color":{"mode":"palette-classic"},"custom":{"drawStyle":"bars","fillOpacity":80,"lineWidth":0,"showPoints":"never","stacking":{"mode":"normal"}}},"overrides":[{"matcher":{"id":"byName","options":"NOERROR"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"green"}}]},{"matcher":{"id":"byName","options":"NXDOMAIN"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"yellow"}}]},{"matcher":{"id":"byName","options":"SERVFAIL"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"red"}}]}]},"options":{"legend":{"displayMode":"table","placement":"right","calcs":["sum","last"]}}},{"id":9,"title":"Cache Statistics","type":"timeseries","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":12,"y":12},"targets":[{"expr":"sum(rate(coredns_cache_hits_total[5m]))","legendFormat":"Cache Hits","refId":"A"},{"expr":"sum(rate(coredns_cache_misses_total[5m]))","legendFormat":"Cache Misses","refId":"B"},{"expr":"sum(coredns_cache_entries)","legendFormat":"Cache Entries","refId":"C"}],"fieldConfig":{"defaults":{"unit":"short","color":{"mode":"palette-classic"},"custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":2,"showPoints":"never"}},"overrides":[{"matcher":{"id":"byName","options":"Cache Entries"},"properties":[{"id":"custom.axisPlacement","value":"right"},{"id":"color","value":{"mode":"fixed","fixedColor":"blue"}}]}]},"options":{"legend":{"displayMode":"list","placement":"bottom"}}},{"id":10,"title":"Forward Requests by Upstream","type":"timeseries","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":0,"y":20},"targets":[{"expr":"sum by (to) (rate(coredns_forward_requests_total[5m]))","legendFormat":"{{to}}","refId":"A"}],"fieldConfig":{"defaults":{"unit":"qps","color":{"mode":"palette-classic"},"custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":2,"showPoints":"never"}}},"options":{"legend":{"displayMode":"table","placement":"right","calcs":["mean","max","last"]}}},{"id":11,"title":"Forward Response Time by Upstream","type":"timeseries","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":12,"y":20},"targets":[{"expr":"histogram_quantile(0.95, sum by (to, le) (rate(coredns_forward_request_duration_seconds_bucket[5m])))","legendFormat":"{{to}} (95th)","refId":"A"}],"fieldConfig":{"defaults":{"unit":"s","color":{"mode":"palette-classic"},"custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":2,"showPoints":"never"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":0.1},{"color":"red","value":0.5}]}}},"options":{"legend":{"displayMode":"table","placement":"right","calcs":["mean","max","last"]}}},{"id":12,"title":"Top 10 Queried Domains","type":"table","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":0,"y":28},"targets":[{"expr":"topk(10, sum by (name) (rate(coredns_dns_requests_total[5m])))","format":"table","instant":true,"refId":"A"}],"transformations":[{"id":"organize","options":{"excludeByName":{"Time":true},"renameByName":{"name":"Domain","Value":"Queries/sec"}}}],"fieldConfig":{"defaults":{"custom":{"align":"left"}},"overrides":[{"matcher":{"id":"byName","options":"Queries/sec"},"properties":[{"id":"custom.displayMode","value":"gradient-gauge"},{"id":"unit","value":"qps"},{"id":"decimals","value":2}]}]},"options":{"showHeader":true,"sortBy":[{"displayName":"Queries/sec","desc":true}]}},{"id":13,"title":"CoreDNS Pod Resource Usage","type":"timeseries","datasource":"Prometheus","gridPos":{"h":8,"w":12,"x":12,"y":28},"targets":[{"expr":"sum(rate(container_cpu_usage_seconds_total{pod=~\"coredns.*\", container!=\"\"}[5m])) * 100","legendFormat":"CPU Usage %","refId":"A"},{"expr":"sum(container_memory_working_set_bytes{pod=~\"coredns.*\", container!=\"\"}) / 1024 / 1024","legendFormat":"Memory Usage (MiB)","refId":"B"}],"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":2,"showPoints":"never"}},"overrides":[{"matcher":{"id":"byName","options":"CPU Usage %"},"properties":[{"id":"unit","value":"percent"},{"id":"custom.axisPlacement","value":"left"}]},{"matcher":{"id":"byName","options":"Memory Usage (MiB)"},"properties":[{"id":"unit","value":"MiB"},{"id":"custom.axisPlacement","value":"right"}]}]},"options":{"legend":{"displayMode":"list","placement":"bottom"}}},{"id":14,"title":"Plugin Status & Health","type":"table","datasource":"Prometheus","gridPos":{"h":8,"w":24,"x":0,"y":36},"targets":[{"expr":"coredns_plugin_enabled","format":"table","instant":true,"refId":"A"}],"transformations":[{"id":"organize","options":{"excludeByName":{"Time":true,"__name__":true,"instance":true,"job":true},"renameByName":{"name":"Plugin Name","server":"Server","zone":"Zone","Value":"Enabled"}}}],"fieldConfig":{"overrides":[{"matcher":{"id":"byName","options":"Enabled"},"properties":[{"id":"custom.displayMode","value":"color-background"},{"id":"mappings","value":[{"options":{"0":{"color":"red","text":"Disabled"},"1":{"color":"green","text":"Enabled"}},"type":"value"}]}]}]},"options":{"showHeader":true}}],"version":1}