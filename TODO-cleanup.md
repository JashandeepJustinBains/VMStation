# TODO: Cleanup & consolidation

A: Prune legacy/outdated scripts, docs, and playbooks (in progress)
- Goal: Remove obsolete shell scripts and duplicate playbooks from `scripts/` and consolidate behavior into idempotent Ansible roles.
- Success criteria: `scripts/` contains only lightweight helpers and docs; all major operational workflows are driven by `ansible/roles/*` and `ansible/playbooks/*`.


B: Implement WOL idle-sleep and Grafana visibility
- Goal: Deploy an hourly idle-check on `masternode` that writes a Prometheus textfile metric and optionally sends WOL packets to worker nodes.
- Tasks:
  - Finalize `ansible/roles/idle-sleep` by adding vaulted MAC addresses to `ansible/inventory/group_vars/secrets.yml` and ensuring `wakeonlan`/`etherwake` are installed on `masternode`.
  - Add `ansible/playbooks/enable-idle-sleep.yaml` to install/start the systemd timer on the `masternode` host group only.
  - Provide a Grafana dashboard JSON (or provisioning snippet) that visualizes `vmstation_idle` and WOL events; place under `manifests/monitoring/` or `docs/`.
- Success criteria: Prometheus shows `vmstation_idle` from the node_exporter textfile collector; Grafana dashboard visualizes idle state and WOL events; masternode can trigger WOL to workers.


C: Archive and tidy root-level artifacts, AI summaries and legacy PR artifacts
- Goal: Identify unnecessary or duplicate files in the repo root (old scripts, autogenerated AI summaries, stale PR artifacts, temporary outputs) and either remove, move to `docs/archive/` or add to `ansible/archive/` with a clear pointer.
- Tasks:
  - Create `docs/archive/` and move AI-generated summaries, large temporary outputs, and old PR notes there with a one-line reason for the archive.
  - For any removed executable scripts, ensure an equivalent Ansible role/playbook exists; if it does, add a short note in the archive describing where behavior moved.
  - Add or update `docs/README.md` documenting where active playbooks, roles, and archive index live.
- Success criteria: repo root contains only active top-level files; archived content is discoverable under `docs/archive/` or `ansible/archive/` with explanatory notes.


D: CI and validation for playbooks and roles
- Goal: Ensure pushes/PRs validate Ansible playbooks and roles via CI and flag style/syntax issues early.
- Tasks:
  - Add GitHub Actions workflows to run: `ansible-playbook --syntax-check`, `ansible-lint`, and `yamllint` across `ansible/`.
  - Add a containerized `ansible-playbook --check` job (dry-run) for the minimal deploy to catch runtime errors in CI.
  - Configure workflows to run on `pull_request` and `push` for working branches (e.g., `minimal-deploy`, `main_broken_20251001`).
- Success criteria: CI files are committed; PRs fail fast on syntax/lint issues; a dry-run smoke test runs in CI and highlights runtime issues.


E: Tests, verification checklist, and recovery playbooks
- Goal: Provide a reproducible verification flow and recovery tasks so the cluster can be validated and recovered without ad-hoc scripts.
- Tasks:
  - Add `ansible/playbooks/verify-cluster-smoke.yaml` that validates: node readiness, CNI pods (flannel/kube-proxy), CoreDNS, and Jellyfin readiness probe status.
  - Add `ansible/playbooks/recover-network.yaml` that runs `network-fix`, restarts kubelet only when handlers fire, and invokes diagnostics when issues persist.
  - Expand `ansible/README-minimal.md` (or create `VERIFY.md`) with explicit verification steps to run on the masternode (preflight, apply, wait, diagnostics, rollback guidance using `main_broken_20251001`).
- Success criteria: smoke verify playbook runs quickly and reports clear PASS/FAIL; `recover-network.yaml` contains idempotent recovery steps and collects artifacts when it cannot fix automatically.


Notes:
- Branch: `minimal-deploy` contains the current refactor and an initial `idle-sleep` role scaffold. Backups are on `main_broken_20251001`.
- Secrets: ensure any MACs or passwords are stored in `ansible/inventory/group_vars/secrets.yml` encrypted with ansible-vault. See `ansible/inventory/group_vars/secrets.yml` for the sanitized placeholder file.

Next actions (recommended):
- Scan the repo root and move obvious AI-generated summaries and temporary files into `docs/archive/`, then update this TODO when moved.
- Add the CI workflow to the repo (I can commit it to `minimal-deploy`) so PR validation runs automatically.
- After CI is enabled: run `ansible-lint`, fix warnings, and add the verify/recover playbooks as small, testable artifacts.
