# Masternode Certificate/Config Fix

## Problem Statement

Worker nodes (192.168.4.61 and 192.168.4.62) were failing to join the Kubernetes cluster with TLS bootstrap timeouts and kubelet errors showing "No API server defined - no node status update will be sent". The root cause was identified as the masternode (192.168.4.63) creating/issuing bad certificates and configurations during cluster initialization.

## Root Cause Analysis

### Primary Issues Identified

1. **Incomplete API Server Certificate SANs**: The kubeadm init command wasn't creating API server certificates with proper Subject Alternative Names (SANs), causing worker nodes to fail certificate validation during TLS bootstrap.

2. **Missing Certificate Upload Configuration**: Certificates weren't being properly prepared for worker node access during the join process.

3. **No Certificate Validation**: No validation was performed to ensure certificates were properly generated before attempting worker joins.

4. **Poor Error Visibility**: Limited diagnostic information when certificate issues occurred, making troubleshooting difficult.

### Original Configuration Problems

**Before Fix** - `ansible/plays/kubernetes/setup_cluster.yaml`:
```yaml
kubeadm init 
--pod-network-cidr={{ pod_network_cidr }}
--apiserver-advertise-address={{ ansible_default_ipv4.address }}
--control-plane-endpoint={{ ansible_default_ipv4.address }}
```

**Issues:**
- No explicit certificate SANs
- No certificate upload preparation
- No certificate validation after init
- No connectivity verification before joins

## Solution Implemented

### 1. Enhanced kubeadm init Configuration

**After Fix**:
```yaml
kubeadm init 
--pod-network-cidr={{ pod_network_cidr }}
--apiserver-advertise-address={{ ansible_default_ipv4.address }}
--control-plane-endpoint={{ ansible_default_ipv4.address }}
--apiserver-cert-extra-sans={{ ansible_default_ipv4.address }},localhost,127.0.0.1
--upload-certs
```

**Improvements:**
- **`--apiserver-cert-extra-sans`**: Adds explicit SANs to API server certificate including the control plane IP, localhost, and 127.0.0.1
- **`--upload-certs`**: Prepares certificates for proper access during worker joins

### 2. Post-Init Certificate Validation

Added comprehensive certificate validation immediately after kubeadm init:

```yaml
- name: Validate certificates generated by kubeadm init
  block:
    - name: Check if API server certificate exists and is valid
      shell: |
        # Verify certificate exists
        if [ ! -f /etc/kubernetes/pki/apiserver.crt ]; then
          echo "ERROR: API server certificate not found"
          exit 1
        fi
        
        # Check certificate validity (24+ hours remaining)
        if ! openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -checkend 86400; then
          echo "ERROR: API server certificate expires within 24 hours"
          exit 1
        fi
        
        # Verify certificate contains required SANs
        SANS=$(openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep -A1 "Subject Alternative Name")
        if [[ "$SANS" != *"{{ ansible_default_ipv4.address }}"* ]]; then
          echo "WARNING: API server certificate may not contain required IP SAN"
        fi
        
        echo "✓ API server certificate is valid"
```

### 3. Enhanced Join Command Validation

Improved join command validation with certificate hash verification:

```yaml
- name: Enhanced join command and certificate validation
  block:
    - name: Verify CA certificate is accessible for join operations
      shell: |
        # Verify CA certificate exists and is valid
        if [ ! -f /etc/kubernetes/pki/ca.crt ]; then
          echo "ERROR: CA certificate not found - worker nodes cannot validate API server"
          exit 1
        fi
        
        # Verify join command contains correct CA hash
        CA_HASH=$(openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //')
        if [[ "{{ join_command.stdout }}" != *"sha256:$CA_HASH"* ]]; then
          echo "WARNING: Join command CA hash may not match actual CA certificate"
        else
          echo "✓ Join command CA hash matches CA certificate"
        fi
```

### 4. Pre-Join Certificate and Connectivity Validation

Added comprehensive pre-join validation for worker nodes:

```yaml
- name: Pre-join certificate and connectivity validation
  block:
    - name: Test API server certificate accessibility from worker node
      shell: |
        # Test basic connectivity to API server
        JOIN_TARGET=$(grep -E "^kubeadm join" /tmp/kubeadm-join.sh | head -1 | awk '{print $3}')
        API_SERVER=$(echo "$JOIN_TARGET" | sed 's/:.*$//')
        
        # Ping test
        if ! ping -c 2 "$API_SERVER" >/dev/null 2>&1; then
          echo "ERROR: Cannot ping API server at $API_SERVER"
          exit 1
        fi
        
        # Port accessibility test
        if ! timeout 10 bash -c "</dev/tcp/$API_SERVER/6443" 2>/dev/null; then
          echo "ERROR: API server port 6443 not accessible"
          exit 1
        fi
        
        # API server response test (should get 401/403 without creds)
        HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" "https://$JOIN_TARGET/healthz" || echo "000")
        if [[ "$HTTP_CODE" != "401" && "$HTTP_CODE" != "403" ]]; then
          echo "WARNING: Unexpected HTTP response: $HTTP_CODE"
        else
          echo "✓ API server is responding correctly"
        fi
        
        # Validate CA certificate hash in join command
        CA_HASH=$(grep -o 'sha256:[a-f0-9]\{64\}' /tmp/kubeadm-join.sh | head -1)
        if [ -z "$CA_HASH" ]; then
          echo "ERROR: No valid CA certificate hash found in join command"
          exit 1
        fi
        
        echo "✓ Pre-join validation successful"
```

## Enhanced Tooling

### 1. Improved generate_join_command.sh

Added certificate validation before generating join commands:

- **Certificate existence checks**: Verifies API server and CA certificates exist
- **Certificate validity checks**: Ensures certificates don't expire within 24 hours
- **CA hash validation**: Verifies generated join command contains correct certificate hash
- **API server accessibility testing**: Tests port 6443 connectivity

### 2. Enhanced troubleshoot_kubelet_join.sh

Added comprehensive certificate diagnostics:

**Control Plane Diagnostics:**
- API server certificate status and SANs
- CA certificate validity
- CA certificate hash for join commands
- API server accessibility testing

**Worker Node Diagnostics:**
- Kubelet client certificate status
- API server reachability from kubelet.conf
- Certificate expiration warnings

### 3. Updated update_and_deploy.sh

Enhanced Kubernetes connectivity check with certificate validation:
- Certificate validity verification during pre-deployment checks
- Early warning for certificate expiration issues
- Better error messages for certificate-related problems

## Files Modified

1. **`ansible/plays/kubernetes/setup_cluster.yaml`** - Core certificate fixes
2. **`generate_join_command.sh`** - Enhanced with certificate validation
3. **`troubleshoot_kubelet_join.sh`** - Added certificate diagnostics
4. **`update_and_deploy.sh`** - Enhanced connectivity checks
5. **`test_certificate_fixes.sh`** - Comprehensive validation test (new)
6. **`MASTERNODE_CERTIFICATE_FIX.md`** - Documentation (this file)

## Expected Results

After applying these fixes:

### ✅ **Improved Certificate Generation**
- API server certificates include proper SANs for worker validation
- Certificates are uploaded and accessible for worker joins
- Certificate validity is ensured before worker join attempts

### ✅ **Better Error Detection**
- Invalid certificates detected before join attempts
- Clear diagnostic information for certificate issues
- Early warnings for certificate expiration

### ✅ **Resolved Join Issues**
- TLS bootstrap timeouts eliminated for certificate-related causes
- "No API server defined" errors resolved
- Worker nodes can successfully validate API server certificates

### ✅ **Enhanced Troubleshooting**
- Comprehensive certificate status in diagnostics
- Clear guidance for certificate-related failures
- Better visibility into root causes of join issues

## Testing and Validation

Run the comprehensive test suite:

```bash
# Validate certificate fixes
./test_certificate_fixes.sh

# Test core functionality
./test_core_functionality.sh

# Validate Ansible syntax
./syntax_validator.sh
```

## Deployment Procedure

1. **Deploy the fixes:**
   ```bash
   ./update_and_deploy.sh
   ```

2. **If cluster exists and has issues, regenerate certificates:**
   ```bash
   # On control plane
   sudo kubeadm certs renew all
   sudo systemctl restart kubelet
   ```

3. **Generate fresh join command:**
   ```bash
   # On control plane
   ./generate_join_command.sh
   ```

4. **Join worker nodes with enhanced validation:**
   ```bash
   # On worker nodes
   sudo <join-command-from-step-3>
   ```

5. **Troubleshoot if needed:**
   ```bash
   # On any node
   sudo ./troubleshoot_kubelet_join.sh
   ```

## Backward Compatibility

- ✅ No breaking changes to existing functionality
- ✅ All existing recovery mechanisms preserved
- ✅ Compatible with both RHEL and Debian systems
- ✅ Maintains VMStation deployment workflow integrity

## Impact Assessment

**Scope**: Surgical changes focused on certificate generation and validation
**Risk**: Very low - adds validation without removing existing functionality
**Benefit**: Resolves the primary blocker preventing worker nodes from joining the cluster

This fix addresses the root cause identified in the problem statement where the masternode was creating/issuing bad certificates and configurations that prevented successful worker node joins.