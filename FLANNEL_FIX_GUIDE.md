# Flannel CrashLoopBackOff - Quick Fix Guide

## Current Status

âœ… **kube-proxy**: Running (35 restarts but now stable)  
âŒ **Flannel**: CrashLoopBackOff (12 restarts)  
âŒ **Loki**: CrashLoopBackOff (depends on Flannel)

---

## Root Cause (Most Likely)

**SELinux on RHEL 10 is blocking Flannel CNI operations**

Flannel needs to:
- Create network interfaces (flannel.1, cni0)
- Write CNI config to /etc/cni/net.d/
- Manage iptables rules
- Create VXLAN tunnels

SELinux in enforcing mode blocks these operations without proper policies.

---

## Immediate Fix - Run This Now

### On masternode:

```bash
cd /srv/monitoring_data/VMStation
git fetch && git pull

# Option 1: Emergency fix script (fastest, ~2 minutes)
chmod +x scripts/fix-flannel-homelab.sh
./scripts/fix-flannel-homelab.sh

# Option 2: Full re-deployment with SELinux fix (3-4 minutes)
./deploy.sh
```

---

## What the Fix Does

1. **Sets SELinux to permissive mode** (allows but logs denials)
2. **Reloads kernel modules**
3. **Verifies iptables-legacy mode**
4. **Cleans up stale CNI interfaces**
5. **Clears CNI config** (regenerated by Flannel)
6. **Restarts kubelet**
7. **Recreates Flannel pod**

---

## Validation

```bash
# Check Flannel status (should be Running within 60 seconds)
kubectl get pods -n kube-flannel --field-selector spec.nodeName=homelab -o wide

# Check for SELinux denials
ssh 192.168.4.62 'getenforce'
# Should show: Permissive

# Check Flannel logs
kubectl logs -n kube-flannel -l app=flannel --field-selector spec.nodeName=homelab -c kube-flannel --tail=30
```

---

## Expected Results

### Before Fix:
```
kube-flannel   kube-flannel-ds-hftm2   0/1  CrashLoopBackOff  12  homelab
monitoring     loki-xxxxx              0/1  CrashLoopBackOff  22  homelab
```

### After Fix:
```
kube-flannel   kube-flannel-ds-xxxxx   1/1  Running  0-2  homelab  âœ“
monitoring     loki-xxxxx              1/1  Running  0-3  homelab  âœ“
```

---

## If Still Broken After Fix

### Run Detailed Diagnostics:

```bash
chmod +x scripts/diagnose-flannel-homelab.sh
./scripts/diagnose-flannel-homelab.sh > flannel-diag.txt
cat flannel-diag.txt
```

This will show:
- Flannel pod status and logs
- CNI config presence
- Flannel interface status
- VXLAN module status
- Network conflicts
- iptables rules
- NetworkManager interference

---

## Common Flannel Errors & Solutions

### Error: "Failed to create subnet: context canceled"
**Cause**: Cannot reach API server or watch stream interrupted  
**Fix**: SELinux blocking network operations â†’ permissive mode

### Error: "CNI config file /etc/cni/net.d/10-flannel.conflist does not exist"
**Cause**: Flannel init container failed to write CNI config  
**Fix**: SELinux blocking file writes â†’ permissive mode

### Error: "failed to add vxlan interface: operation not permitted"
**Cause**: SELinux blocking interface creation  
**Fix**: SELinux permissive mode + vxlan module loaded

### Error: "failed to acquire lease: context canceled"
**Cause**: Cannot allocate pod subnet from cluster CIDR  
**Fix**: Check kube-controller-manager has --allocate-node-cidrs=true

---

## Manual SELinux Fix (if script doesn't work)

```bash
# SSH to homelab
ssh 192.168.4.62

# Set SELinux to permissive
sudo setenforce 0

# Make it persist on reboot
sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config

# Verify
getenforce
# Should show: Permissive

# Restart kubelet
sudo systemctl restart kubelet

# Exit and delete Flannel pod
exit
kubectl delete pod -n kube-flannel -l app=flannel --field-selector spec.nodeName=homelab
```

---

## Why SELinux is the Issue

RHEL 10 comes with SELinux **enforcing** by default. Flannel needs to:

1. **Create network devices**: flannel.1 (VXLAN), cni0 (bridge)
2. **Write CNI config**: /etc/cni/net.d/10-flannel.conflist
3. **Modify iptables**: NAT and forwarding rules
4. **Access host network**: VXLAN on UDP 8472

Without proper SELinux policies, all of these are **denied**.

**Temporary Solution**: Permissive mode (logs denials but allows operations)  
**Future Solution**: Create custom SELinux module for Flannel

---

## Long-Term Fix (Future)

1. Run Flannel with SELinux permissive
2. Collect SELinux denials: `ausearch -m avc -ts recent`
3. Create custom SELinux policy module
4. Test policy in enforcing mode
5. Document for future RHEL deployments

**Reference**: [SELinux and Kubernetes](https://www.redhat.com/en/blog/running-containers-rhel-8-selinux-enabled)

---

## Files Changed

- `ansible/roles/network-fix/tasks/main.yml`: Added SELinux permissive configuration
- `scripts/fix-flannel-homelab.sh`: Emergency Flannel fix script
- `scripts/diagnose-flannel-homelab.sh`: Flannel diagnostics script

**Commit**: ad5cb46

---

## Quick Command Summary

```bash
# Emergency fix (run from masternode)
cd /srv/monitoring_data/VMStation
git pull
chmod +x scripts/fix-flannel-homelab.sh
./scripts/fix-flannel-homelab.sh

# Validate
kubectl get pods -n kube-flannel --field-selector spec.nodeName=homelab
kubectl get pods -n monitoring -l app.kubernetes.io/name=loki

# If still broken
chmod +x scripts/diagnose-flannel-homelab.sh
./scripts/diagnose-flannel-homelab.sh
```

---

**Next**: Run the fix script and Flannel should stabilize within 60 seconds! ðŸš€
